---
title: "LME diagnostics"
author: "Kevin O'Brien"
date: "Tuesday, July 07, 2015"
output: html_document
---

```{r}
#using package NLME

library(nlme)
````
```{r}
# Systolic blood pressure measurements made 
# simultaneously by two observers (J and R) 
# and an automatic blood pressure measuring
# machine (S), each making three observations 
# in quick succession (supplied by Dr E O'Brien)

Blood <- matrix(data=c(100, 106, 107, 98, 98, 111, 
122, 128, 124, 108, 110, 108, 108, 112, 110, 121, 
127, 128, 76, 84, 82, 76, 88, 82, 95, 94, 98,
108, 104, 104, 110, 100, 106, 127, 127, 135,
124, 112, 112, 128, 112, 114, 140, 131, 124,
122, 140, 124, 124, 140, 126, 139, 142, 136,
116, 108, 102, 118, 110, 102, 122, 112, 112,
114, 110, 112, 112, 108, 112, 130, 129, 135,
100, 108, 112, 100, 106, 112, 119, 122, 122,
108, 92, 100, 108, 98, 100, 126, 113, 111,
100, 106, 104, 102, 108, 106, 107, 113, 111,
108, 112, 122, 108, 116, 120, 123, 125, 125,
112, 112, 110, 114, 112, 110, 131, 129, 122,
104, 108, 104, 104, 108, 104, 123, 126, 114,
106, 108, 102, 104, 106, 102, 127, 119, 126,
122, 122, 114, 118, 122, 114, 142, 133, 137,
100, 102, 102, 102, 102, 100, 104, 116, 115,
118, 118, 120, 116, 118, 118, 117, 113, 112,
140, 134, 138, 138, 136, 134, 139, 127, 113,
150, 148, 144, 148, 146, 144, 143, 155, 133,
166, 154, 154, 164, 154, 148, 181, 170, 166,
148, 156, 134, 136, 154, 132, 149, 156, 140,
174, 172, 166, 170, 170, 164, 173, 170, 154,
174, 166, 150, 174, 166, 154, 160, 155, 170,
140, 144, 144, 140, 144, 144, 158, 152, 154,
128, 134, 130, 128, 134, 130, 139, 144, 141,
146, 138, 140, 146, 138, 138, 153, 150, 154,
146, 152, 148, 146, 152, 148, 138, 144, 131,
220, 218, 220, 220, 218, 220, 228, 228, 226,
208, 200, 192, 204, 200, 190, 190, 183, 184,
94, 84, 86, 94, 84, 88, 103, 99, 106,
114, 124, 116, 112, 126, 118, 131, 131, 124,
126, 120, 122, 124, 120, 120, 131, 123, 124,
124, 124, 132, 126, 126, 120, 126, 129, 125,
110, 120, 128, 110, 122, 126, 121, 114, 125,
90, 90, 94, 88, 88, 94, 97, 94, 96,
106, 106, 110, 106, 108, 110, 116, 121, 127,
218, 202, 208, 218, 200, 206, 215, 201, 207,
130, 128, 130, 128, 126, 128, 141, 133, 146,
136, 136, 130, 136, 138, 128, 153, 143, 138,
100, 96, 88, 100, 96, 86, 113, 107, 102,
100, 98, 88, 100, 98, 88, 109, 105, 97,
124, 116, 122, 126, 116, 122, 145, 102, 137,
164, 168, 154, 164, 168, 154, 192, 178, 171,
100, 102, 100, 100, 104, 102, 112, 116, 116,
136, 126, 122, 136, 124, 122, 152, 144, 147,
114, 108, 122, 114, 108, 122, 141, 141, 137,
148, 120, 132, 146, 130, 132, 206, 188, 166,
160, 150, 148, 160, 152, 146, 151, 147, 136,
84, 92, 98, 86, 92, 98, 112, 125, 124,
156, 162, 152, 156, 158, 152, 162, 165, 189,
110, 98, 98, 108, 100, 98, 117, 118, 109,
100, 106, 106, 100, 108, 108, 119, 131, 124,
100, 102, 94, 100, 102, 96, 136, 116, 113,
86, 74, 76, 88, 76, 76, 112, 115, 104,
106, 100, 110, 106, 100, 108, 120, 118, 132,
108, 110, 106, 106, 118, 106, 117, 118, 115,
168, 188, 178, 170, 188, 182, 194, 191, 196,
166, 150, 154, 164, 150, 154, 167, 160, 161,
146, 142, 132, 144, 142, 130, 173, 161, 154,
204, 198, 188, 206, 198, 188, 228, 218, 189,
96, 94, 86, 96, 94, 84, 77, 89, 101,
134, 126, 124, 132, 126, 124, 154, 156, 141,
138, 144, 140, 140, 142, 138, 154, 155, 148,
134, 136, 142, 136, 134, 140, 145, 154, 166,
156, 160, 154, 156, 162, 156, 200, 180, 179,
124, 138, 138, 122, 140, 136, 188, 147, 139,
114, 110, 114, 112, 114, 114, 149, 217, 192,
112, 116, 122, 112, 114, 124, 136, 132, 133,
112, 116, 134, 114, 114, 136, 128, 125, 142,
202, 220, 228, 200, 220, 226, 204, 222, 224,
132, 136, 134, 134, 136, 132, 184, 187, 192,
158, 162, 152, 158, 164, 150, 163, 160, 152,
88, 76, 88, 90, 76, 86, 93, 88, 88,
170, 174, 176, 172, 174, 178, 178, 181, 181,
182, 176, 180, 184, 174, 178, 202, 199, 195,
112, 114, 124, 112, 112, 126, 162, 166, 148,
120, 118, 120, 118, 116, 120, 227, 227, 219,
110, 108, 106, 110, 108, 106, 133, 127, 126,
112, 112, 106, 112, 110, 106, 202, 190, 213,
154, 134, 130, 156, 136, 132, 158, 121, 134,
116, 112, 94, 118, 114, 96, 124, 149, 137,
108, 110, 114, 106, 110, 114, 114, 118, 126,
106, 98, 100, 104, 100, 100, 137, 135, 134,
122, 112, 112, 122, 114, 114, 121, 123, 128), 
nrow = 85, ncol = 9, byrow = TRUE,
dimnames = list(NULL, c("J1","J2","J3","R1","R2","R3","S1","S2","S3")) )

```
### Working on the JS comparison
```{r}
blood = groupedData( BP ~ method | subject ,
  data = data.frame( BP = c(Blood), 
		subject = rep(seq(nrow(Blood)), ncol(Blood)),
		method = rep(c("J","R","S"), rep(nrow(Blood)*3, 3)),
		repl = rep(rep(c(1:3), rep(nrow(Blood), 3)), 3) ),
	labels = list(BP = "Systolic Blood Pressure", method = "Measurement Device"),
	)
```

```{r}
# consider on methods "J" and "S"
dat = subset(blood, subset = method != "R") # fixed-effects X_i with(subset(dat, subset = subject == "1"), model.matrix(BP ~ method)) # random-effects Z_i with(subset(dat, subset = subject == "1"), model.matrix( ~ method -1))


# consider J and S groups only:
J.sd = c(with(subset(blood, subset = method == "J"), by(BP, subject, sd))) 
S.sd = c(with(subset(blood, subset = method == "S"), by(BP, subject, sd)))
min(J.sd) ; max(J.sd)
min(S.sd) ; max(S.sd)
plot(J.sd, S.sd)
```

```{r}
# make a data frame containing J and S groups only:
dat = subset(blood, subset = method != "R")

# lines plot of cell means:
with(dat, interaction.plot(method, subject, BP, legend = FALSE))

```

```{r}
fit1 = lme( BP ~ method, data = dat, random = ~1 | subject )
fit2 = update(fit1, random = ~1 | subject/method )
fit3 = update(fit1, random = ~method - 1 | subject )
#analysis of variance
anova(fit1,fit2,fit3)
```

```{r}
###########################################
head(blood)

#####################################
```



```{r}
JS.roy1 = lme(BP ~ method-1, data = dat,random = list(subject=pdSymm(~ method-1)), weights=varIdent(form=~1|method),correlation = corSymm(form=~1 | subject/repl), method="ML")

JS.roy2 = lme(BP ~ method-1, data = dat,random = list(subject=pdCompSymm(~ method-1)), correlation = corSymm(form=~1 | subject/repl), method="ML")

JS.roy3 = lme(BP ~ method-1, data = dat,random = list(subject=pdSymm(~ method-1)),weights=varIdent(form=~1|method), correlation = corCompSymm(form=~1 | subject/repl), method="ML")

JS.roy4 = lme(BP ~ method-1, data = dat,random = list(subject=pdCompSymm(~ method-1)), correlation = corCompSymm(form=~1 | subject/repl), method="ML")
```

```{r}
###################################################
### code chunk: Chap20.3influence_init
###################################################

options(width = 65, digits = 5, show.signif.stars = FALSE)
date()
packageVersion("nlmeU")
packageVersion("nlme")
packageVersion("lattice")
```

```{r}
sessionInfo()
require(nlme)    
require(lattice) 
```

```{r}

data(armd, package="nlmeU")

## Model M16.5 
lm3.form <-                 # (12.9, 16.17)
      formula(visual ~ visual0 + time + treat.f) 
fm16.5  <-                  # R16.13
lme(lm3.form,              
        random = list(subject = pdDiag(~time)),       
        weights =varPower(form=~time),
        data = armd)     

```

### code chunk: R20.6a

```{r}
fm16.5ml <- update(fm16.5, method = "ML") # ML estimation
formula(fm16.5ml)                         # Recall model formula.
fm16.5ml$call$data                        # Recall data name.
logLik(fm16.5ml)                          # Log-likelihood value

```

```{r}
formula(JS.roy4)                         # Recall model formula.
JS.roy4$call$data                        # Recall data name.
logLik(JS.roy4)                          # Log-likelihood value

```
### code chunk: R20.6b


```{r}
beta0  <- fixef(fm16.5ml)                 # beta
names(beta0)                              # Long names
names(beta0) <- abbreviate(names(beta0), minlength = 7) # Short names 
beta0                                     # beta printed.
vcovb  <- vcov(fm16.5ml)                  # vcovb 
colnames(vcovb) <- names(beta0)           # Short names
vcovb                                     # vcovb printed. 

```
#### Applied to JS comparison
```{r}

beta0.js  <- fixef(JS.roy1)                 # beta
names(beta0.js)                              # Long names
names(beta0.js) <- abbreviate(names(beta0.js), minlength = 7) # Short names 
beta0.js                                    # beta printed.
vcovb.js  <- vcov(JS.roy1)                  # vcovb 
colnames(vcovb.js) <- names(beta0.js)           # Short names
vcovb.js
```
### code chunk: R20.7a

```{r}

require(nlmeU)  
df1 <- subset(armd, subject %in% "1")          # Data for subject "1" 
logLik1(fm16.5ml, df1)         # logLik_i for subject "1" 
```

```{r}
# require(nlmeU)  
df1 <- subset(dat, subject %in% "1")          # Data for subject "1" 
logLik1(JS.roy1, df1)         # logLik_i for subject "1" 
```


```{r}
lLik.i <- by(armd, armd$subject,
   FUN = function(dfi) logLik1(fm16.5ml, dfi))
lLik.i <- as.vector(lLik.i)   # Coerse array to vector  
lLik.i[1:5]               # logLik_i for the first five subjects
sum(lLik.i)               # Sum logLik_i; compare to Panel 20.6a
```

### code chunk: R20.7b

```{r}

nx <- by(armd, armd$subject, nrow)             # ni
lLik.n <- lLik.i/as.vector(nx)                 # logLiki
outL <- lLik.n < -6                            # TRUE for values < -6
lLik.n[outL]                                   # logLiki/ni <  -6
subject.c <- levels(armd$subject)
subject.x <- as.numeric(subject.c)

plot(lLik.n ~ subject.x, type = "h")           # Fig. 20.1
points(subject.x[outL], lLik.n[outL], type = "p", pch = 16)
text(subject.x[outL], lLik.n[outL], subject.c[outL])
```

### code chunk: R20.8a

```{r}
lmeU <- function(cx) { 
    dfU <- subset(armd, subject != cx)          # LOO data 
    update(fm16.5ml, data = dfU)                # LOO fit 
}

lmeUall        <- lapply(subject.c, lmeU)       # List with LOO fits
names(lmeUall) <- subject.c                     # Names assigned          
```

### code chunk: R20.8b

```{r}

names(lmeUall)[1:6]                             
dataU6 <- lmeUall[["6"]]$data     # LOO data for subject 6
dim(dataU6)                       # Number of rows is 863
unique(dataU6$subject)[1:6]       # Subject no. 6 omitted
```
### code chunk: R20.9a
```{r}
lLik <- function(cx){                  
    lmeU   <- lmeUall[[cx]]           # LOO fit extracted 
    lLikU  <- logLik(lmeU, REML = FALSE)  # LOO log-likelihood
    df.s   <-                         # Data for subject cx...
       subset(armd, subject == cx)                 
    lLik.s <- logLik1(lmeU, df.s)       # ...and log-likelihood.
    return(lLikU + lLik.s)            # "Displaced" log-likelihood...
}
lLikUall <- sapply(subject.c, lLik)     # ...for all subjects.         

dif.2Lik <- 2*(logLik(fm16.5ml) - lLikUall) # Vector of LDi
summary(dif.2Lik)
```

### code chunk: R20.9b

```{r}


names(dif.2Lik) <- subject.c              # Subjects' ids assigned
outL  <-  dif.2Lik > 0.5                  # Outlying LDi's
dif.2Lik[outL]
library(lattice)

```

```{r}
subject.f <- factor(subject.c, levels = subject.c)
myPanel <- function(x, y, ...){
   x1 <- as.numeric(x)
   panel.xyplot(x1, y, ...)
   ltext(x1[outL], y[outL], subject.c[outL])  # Label outlying LDi
}

dtp <-                                        # Fig. 20.2
   dotplot(dif.2Lik ~ subject.f, panel = myPanel, type = "h")           
lxlims <- length(dtp$x.limits)         
update(dtp, xlim = rep("", lxlims), grid = "h") 


```

### code chunk: R20.10a

```{r}
betaUall <- sapply(lmeUall, fixef)          # Matrix with beta(-i)
vb.inv <- solve(vcovb)                       
CookDfun <- function(betaU){  
   dbetaU <- betaU - beta0                  # beta(-i) - beta
   CookD.value <- t(dbetaU) %*% vb.inv %*% dbetaU 
}
CookD.num <- apply(betaUall, 2, CookDfun)
(n.fixeff <- length(beta0))                 # Number of fixed effects
rankX <- n.fixeff                           # Rank of matrix X
CookD <- CookD.num/rankX                    # Cook's distance Di

```
### code chunk: R20.10b

```{r}

outD <- CookD > 0.03                        # Outlying Di's
subject.c[outD]                             # Subjects' ids 

plot(CookD ~ subject.c, 
     ylab = "Cook's D", type = "h")         # Fig. 20.3
text(as.numeric(subject.c[outD]),
     CookD[outD], subject.c[outD])          # Annotation 
points(subject.c[outD], CookD[outD])

sessionInfo()
```
